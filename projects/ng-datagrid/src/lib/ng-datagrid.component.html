<ng-template #defaultEditTemplate let-formGroup="formGroup" let-column="column">
  <input *ngIf="formGroup?.contains(column.field)" [formControl]="formGroup.get(column.field)">
</ng-template>

<ng-template #defaultCellTemplate let-dataItem="dataItem" let-column="column">
  <ng-container *ngIf="column?.field">{{column.fieldFn(dataItem)}}</ng-container>
</ng-template>

<ng-template
  #cellTemplate
  let-dataItem="dataItem"
  let-formGroup="formGroup"
  let-column="column"
  let-rowIndex="rowIndex"
  let-isNew="isNew"
  let-isEditing="isEditing"
>
  <ng-container [ngSwitch]="isEditing">
    <!--region CellTemplate-->
    <ng-container *ngSwitchCase="false">
      <ng-template
        [ngTemplateOutlet]="!column.cellTemplate ? defaultCellTemplate : column.cellTemplate.templateRef"
        [ngTemplateOutletContext]="{$implicit: dataItem, dataItem, rowIndex, column}"
      ></ng-template>
    </ng-container>
    <!--endregion CellTemplate-->

    <!--region EditTemplate-->
    <ng-container *ngSwitchCase="true">
      <ng-template
        [ngTemplateOutlet]="!column.editTemplate ? defaultEditTemplate : column.editTemplate.templateRef"
        [ngTemplateOutletContext]="{$implicit: formGroup, formGroup, rowIndex, column, dataItem, isNew}"
      ></ng-template>
    </ng-container>
    <!--region EditTemplate-->
  </ng-container>

</ng-template>

<div *ngIf="toolbar && (toolbarPosition === 'top' || toolbarPosition === 'both')" class="ng-dg-toolbar top">
  <ng-template [ngTemplateOutletContext]="{}" [ngTemplateOutlet]="toolbar.templateRef"></ng-template>
</div>

<!--HEADER-->
<div [style.paddingRight.px]="containerElem.offsetWidth - containerElem.clientWidth - 1"
     [style.border-right-width]="containerElem.offsetWidth - containerElem.clientWidth - 1 <= 0 ? 0 : null" class="ng-dg-header">
  <div class="ng-dg-header-inner" [scrollLeft]="containerElem.scrollLeft">
    <table>
      <colgroup>
        <col *ngFor="let column of columns.toArray() || []"
             [style.width.px]="column.width"
        >
      </colgroup>

      <thead>
      <tr>
        <th *ngFor="let column of columns.toArray() || []">
          <ng-container *ngIf="!column.headerTemplate">{{column.title}}</ng-container>
          <ng-container *ngIf="column.headerTemplate">
            <ng-template [ngTemplateOutletContext]="{}"
                         [ngTemplateOutlet]="column.headerTemplate.templateRef"></ng-template>
          </ng-container>
        </th>
      </tr>
      </thead>

    </table>
  </div>
</div>

<div #containerElem class="ng-dg-container" (scroll)="$event">

  <table>

    <colgroup>
      <col *ngFor="let column of columns.toArray() || []"
           [style.width.px]="column.width"
      >
    </colgroup>

    <tbody>

    <tr *ngIf="editOptions && editOptions[-1]" class="ng-dg-alt ng-dg-editable">
      <td *ngFor="let column of columns.toArray()">
        <ng-template
          [ngTemplateOutlet]="cellTemplate"
          [ngTemplateOutletContext]="{dataItem: undefined, column, rowIndex: -1, formGroup: editOptions[-1].formGroup, isNew: true, isEditing: column.editable !== false}"
        ></ng-template>
      </td>
    </tr>

    <tr *ngFor="let dataItem of data || []; let rowIndex = index"
        [ngClass]="{'ng-dg-alt': rowIndex % 2, 'ng-dg-editable': !!editOptions[rowIndex]}">
      <td *ngFor="let column of columns.toArray()">
        <ng-template
          [ngTemplateOutlet]="cellTemplate"
          [ngTemplateOutletContext]="{dataItem, column, rowIndex, formGroup: editOptions[rowIndex]?.formGroup, isNew: false, isEditing: column.editable !== false && !!editOptions[rowIndex] && (editOptions[rowIndex].formGroup.contains(column.field) || !!column.editTemplate)}"
        ></ng-template>
      </td>
    </tr>

    <tr *ngIf="!data.length">
      <td [colSpan]="columns.length">
        No data found.
      </td>
    </tr>

    </tbody>

  </table>

</div>

<!--FOOTER-->
<div *ngIf="columns.find(hasFooter)" [style.paddingRight.px]="containerElem.offsetWidth - containerElem.clientWidth - 1"
     class="ng-dg-footer">
  <div class="ng-dg-footer-inner" [scrollLeft]="containerElem.scrollLeft">
    <table>

      <colgroup>
        <col *ngFor="let column of columns.toArray() || []"
             [style.width.px]="column.width"
        >
      </colgroup>

      <tbody>
      <tr>
        <td *ngFor="let column of columns.toArray() || []">
          <ng-template [ngTemplateOutletContext]="{}"
                       [ngTemplateOutlet]="column.footerTemplate?.templateRef"></ng-template>
        </td>
      </tr>
      </tbody>

    </table>
  </div>
</div>

<!--TOOLBAR-->
<div *ngIf="toolbar && (toolbarPosition === 'bottom' || toolbarPosition === 'both')" class="ng-dg-toolbar bottom">
  <ng-template [ngTemplateOutletContext]="{}" [ngTemplateOutlet]="toolbar.templateRef"></ng-template>
</div>
